// app/main.js (ÊúÄÁµÇ‰øÆÊ≠£Áâà - ÂÖ®Êñá)

import { 
    getCurrentState, 
    getTensionInstance, 
    addTension, 
    setActiveUser, 
    actTransfer, // üí° ËøΩÂä†: actTransfer
    deleteAccounts 
} from '../core/foundation.js'; 
import { actMintCurrency, actExchangeCurrency } from '../core/currency.js'; 

// =========================================================================
// ÂÆöÊï∞„Å®„Éò„É´„Éë„Éº
// =========================================================================

const SUPPORTED_CURRENCIES = ["USD", "JPY", "EUR", "BTC", "ETH", "MATIC"];
const TENSION_LIMIT = 0.5; 

let UI_ELEMENTS = {};

/**
 * „Åô„Åπ„Å¶„ÅÆUIË¶ÅÁ¥†„ÅÆID„Çí„Ç≠„É£„ÉÉ„Ç∑„É•„Åô„Çã
 */
function cacheUIElements() {
    const ids = [
        'status_message', 'tension_level_display', 'tension_bar', 'tension_level_display_bar',
        'intensity_display', 'rigor_display', 'active_user_select', 
        'active_user_name', 'recipient_input', 
        'amount_input', 'autonomy_status', 'transfer_internal_button', 
        'transfer_external_button', 'revision_button', 'delete_accounts_button',
        'mint_amount_input', 'dialogue-output', 'dialogue_input', 'dialogue_button',
        'exchange_amount_input', 'exchange_from_select', 'exchange_to_select', 
        'exchange_button',
        'mint_currency_select', 'mint_execute_button', 'css_reset_button'
    ];
    
    SUPPORTED_CURRENCIES.forEach(c => {
        ids.push(`balance_${c}`); 
    });
    
    ids.forEach(id => {
        const el = document.getElementById(id);
        if (!el) {
             if (id === 'status_message' || id === 'tension_level_display') {
                 console.error(`Missing critical UI element ID: ${id}`);
                 throw new Error(`Critical UI element missing: ${id}. Check index.html.`);
            }
        }
        UI_ELEMENTS[id] = el;
    });
}

function logToConsole(message, type = 'ai-message') {
    const output = UI_ELEMENTS['dialogue-output'];
    if (!output) return; 
    const messageDiv = document.createElement('div');
    messageDiv.className = type;
    messageDiv.innerHTML = `<strong>[CORE]:</strong> ${message}`;
    output.appendChild(messageDiv);
    output.scrollTop = output.scrollHeight; 
}

// =========================================================================
// UIÊõ¥Êñ∞„É≠„Ç∏„ÉÉ„ÇØ
// =========================================================================

/**
 * UIÂÖ®‰Ωì„ÇíÊúÄÊñ∞„ÅÆÁä∂ÊÖã„Å´Âü∫„Å•„ÅÑ„Å¶Êõ¥Êñ∞„Åô„Çã
 */
function updateUI(state) {
    const tension = getTensionInstance();
    const tensionValue = tension.getValue ? tension.getValue() : tension.value; // tension.getValue()„ÅåÊú™ÂÆöÁæ©„ÅÆÂ†¥Âêà„ÇíËÄÉÊÖÆ
    const activeUserName = state.active_user;
    
    if (UI_ELEMENTS['status_message']) {
        UI_ELEMENTS['status_message'].textContent = `[STATUS]: ${state.status_message}`;
    }
    
    // Tension & Autonomy Status
    if (UI_ELEMENTS['tension_level_display']) {
        UI_ELEMENTS['tension_level_display'].textContent = `T: ${tensionValue.toFixed(4)}`;
    }
    const tensionBarEl = UI_ELEMENTS['tension_level_display_bar'];
    if (tensionBarEl) { 
        const tensionPercent = Math.min(tensionValue / TENSION_LIMIT, 1) * 100;
        tensionBarEl.style.width = `${tensionPercent}%`;
        tensionBarEl.style.backgroundColor = (tensionValue > TENSION_LIMIT * 0.7) ? '#dc3545' : '#ffc107';
    }
    const autonomyStatusEl = UI_ELEMENTS['autonomy_status'];
    if (autonomyStatusEl) {
        if (tensionValue > TENSION_LIMIT) {
            autonomyStatusEl.innerHTML = `Êö¥Ëµ∞ÊäëÊ≠¢„Çπ„ÉÜ„Éº„Çø„Çπ: **Ë≠¶Âëä (T > ${TENSION_LIMIT.toFixed(4)})**`;
            autonomyStatusEl.style.color = '#dc3545';
        } else if (tensionValue > TENSION_LIMIT * 0.7) {
            autonomyStatusEl.innerHTML = `Êö¥Ëµ∞ÊäëÊ≠¢„Çπ„ÉÜ„Éº„Çø„Çπ: **È´òÁ∑äÂºµ**`;
            autonomyStatusEl.style.color = '#ffc107';
        } else {
            autonomyStatusEl.innerHTML = `Êö¥Ëµ∞ÊäëÊ≠¢„Çπ„ÉÜ„Éº„Çø„Çπ: **‰ΩéÁ∑äÂºµ**`;
            autonomyStatusEl.style.color = '#28a745';
        }
    }

    // Êï∞ÁêÜÁöÑÂà∂Âæ°„Éë„É©„É°„Éº„Çø (I/R) 
    if (UI_ELEMENTS['intensity_display']) { UI_ELEMENTS['intensity_display'].textContent = "0.9025"; } 
    if (UI_ELEMENTS['rigor_display']) { UI_ELEMENTS['rigor_display'].textContent = "0.2236"; }
    
    // Active User & Balance
    if (UI_ELEMENTS['active_user_name']) {
        UI_ELEMENTS['active_user_name'].textContent = activeUserName;
    }
    
    // Â§öÈÄöË≤®ÊÆãÈ´ò„ÅÆÊõ¥Êñ∞„É≠„Ç∏„ÉÉ„ÇØ
    const accounts = state.accounts[activeUserName];
    SUPPORTED_CURRENCIES.forEach(currency => {
        const el = UI_ELEMENTS[`balance_${currency}`];
        if (el) { 
            const balance = accounts[currency] || 0;
            if (currency === "JPY") {
                 el.textContent = Math.floor(balance).toLocaleString();
            } else if (["BTC", "ETH", "MATIC"].includes(currency)) {
                 el.textContent = balance.toFixed(8);
            } else {
                 el.textContent = balance.toFixed(2);
            }
        }
    });

    // „É¶„Éº„Ç∂„ÉºÈÅ∏ÊäûËÇ¢„ÅÆÊõ¥Êñ∞
    const selectEl = UI_ELEMENTS['active_user_select'];
    if (selectEl) {
        selectEl.innerHTML = '';
        Object.keys(state.accounts).forEach(user => {
            const option = document.createElement('option');
            option.value = user;
            option.textContent = user;
            if (user === activeUserName) {
                option.selected = true;
            }
            selectEl.appendChild(option);
        });
    }
}


// =========================================================================
// „Ç§„Éô„É≥„Éà„Éè„É≥„Éâ„É©„Éº (‰ΩúÁÇ∫)
// =========================================================================

/**
 * ÈÄöË≤®ÁîüÊàêÂÆüË°å„Éú„Çø„É≥„ÅÆ„Éè„É≥„Éâ„É©„Éº (Minting Act)
 */
function handleMintingExecuteAct() {
    try {
        const currency = UI_ELEMENTS['mint_currency_select'].value;
        const amount = parseFloat(UI_ELEMENTS['mint_amount_input'].value);
        
        if (isNaN(amount) || amount <= 0) {
            logToConsole("ÁîüÊàêÊï∞Èáè„ÅØÊ≠£„ÅÆÂÄ§„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", 'user-message');
            return;
        }

        const state = getCurrentState();
        const newState = actMintCurrency(state.active_user, currency, amount);
        
        logToConsole(`${state.active_user} „Åå ${amount.toFixed(2)} ${currency} „ÇíÁîüÊàê„Åó„Åæ„Åó„Åü„ÄÇTension„ÅåÂ¢óÂä†„Åó„Åæ„Åó„Åü„ÄÇ`, 'ai-message');
        updateUI(newState);
        
    } catch (error) {
        logToConsole(`Minting Act Â§±Êïó: ${error.message}`, 'error-message');
        console.error(error);
    }
}

/**
 * ÈÄöË≤®‰∫§ÊèõÂÆüË°å„Éú„Çø„É≥„ÅÆ„Éè„É≥„Éâ„É©„Éº (Exchange Act)
 */
function handleExchangeAct() {
    try {
        const fromC = UI_ELEMENTS['exchange_from_select'].value;
        const toC = UI_ELEMENTS['exchange_to_select'].value;
        const amount = parseFloat(UI_ELEMENTS['exchange_amount_input'].value);

        if (fromC === toC) {
            logToConsole("Âêå„ÅòÈÄöË≤®Èñì„ÅÆ‰∫§Êèõ„ÅØ„Åß„Åç„Åæ„Åõ„Çì„ÄÇ", 'user-message');
            return;
        }
        if (isNaN(amount) || amount <= 0) {
            logToConsole("‰∫§ÊèõÊï∞Èáè„ÅØÊ≠£„ÅÆÂÄ§„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", 'user-message');
            return;
        }
        
        const state = getCurrentState();
        const newState = actExchangeCurrency(state.active_user, fromC, amount, toC);
        
        logToConsole(`${state.active_user} „Åå ${amount.toFixed(4)} ${fromC} „Çí ${toC} „Å´‰∫§Êèõ„Åó„Åæ„Åó„Åü„ÄÇ`, 'ai-message');
        updateUI(newState);
        
    } catch (error) {
        logToConsole(`Exchange Act Â§±Êïó: ${error.message}`, 'error-message');
        console.error(error);
    }
}

/**
 * ÈÄÅÈáë (Transfer Act) „Éè„É≥„Éâ„É©„Éº - ÊÆãÈ´òÊ∂àË≤ª„É≠„Ç∏„ÉÉ„ÇØ„ÇíÂÆüË£Ö
 */
function handleTransfer(isExternal) {
    const CURRENCY = 'USD'; // ÈÄöË≤®„ÅØUSDÂõ∫ÂÆö
    
    try {
        let recipient = UI_ELEMENTS['recipient_input'].value;
        const amount = parseFloat(UI_ELEMENTS['amount_input'].value);
        const state = getCurrentState();

        if (isNaN(amount) || amount <= 0) { 
             logToConsole("ÊúâÂäπ„Å™Êï∞Èáè„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", 'user-message'); return; 
        }
        
        // Â§ñÈÉ®ÈÄÅÈáë„ÅÆÂ†¥Âêà„ÄÅÂèóÂèñ‰∫∫„Çí "External_Gateway" „Å´Âº∑Âà∂Ë®≠ÂÆöÔºàÁõ£Êüª„ÅÆ„Åü„ÇÅÔºâ
        if (isExternal) {
            if (!recipient || recipient === 'User_B' || recipient === 'User_C') {
                 recipient = 'External_Gateway'; 
            } else {
                 recipient = 'External_Gateway (' + recipient + ')'; 
            }
        }
        
        if (!recipient || recipient === state.active_user) { 
             logToConsole("ÊúâÂäπ„Å™ÂèóÂèñ‰∫∫„ÇíÊåáÂÆö„Åó„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ", 'user-message'); return; 
        }
        
        // 1. ÊÆãÈ´òÊ∂àË≤ª„Å®ÁßªÂãï„ÅÆÂÆüË°å (actTransfer„Çí‰ΩøÁî®)
        const newState = actTransfer(state.active_user, recipient, amount, CURRENCY);
        
        // Tension„ÅÆË®àÁÆó„Å®Â¢óÂä†
        const tensionAmount = isExternal ? amount * 0.0001 : amount * 0.00001;
        addTension(tensionAmount); 
        
        const actType = isExternal ? 'Â§ñÈÉ®ÈÄÅÈáëÔºàÈ´òÊë©Êì¶Ôºâ' : 'ÂÜÖÈÉ®ÈÄÅÈáëÔºà‰ΩéÊë©Êì¶Ôºâ';
        
        // „É≠„Ç∞Ë°®Á§∫
        logToConsole(`${state.active_user} „Åå ${recipient} „Å∏ **$${amount.toFixed(2)} ${CURRENCY}** „Çí ${actType} „Åó„Åæ„Åó„Åü„ÄÇTension„Åå${tensionAmount.toFixed(6)}Â¢óÂä†„ÄÇ`, 'ai-message');
        updateUI(newState);
        
    } catch (error) {
        logToConsole(`Transfer Act Â§±Êïó: ${error.message}`, 'error-message');
        console.error(error);
    }
}

function handleUserSelect(event) {
    const newActiveUser = event.target.value;
    setActiveUser(newActiveUser);
    logToConsole(`„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„Éº„Çí ${newActiveUser} „Å´Âàá„ÇäÊõø„Åà„Åæ„Åó„Åü„ÄÇ`, 'user-message');
    updateUI(getCurrentState());
}

function handleDeleteAccounts() {
    if (confirm("üö® Ë≠¶Âëä: ÂÖ®„Å¶„ÅÆÂè£Â∫ßÊÉÖÂ†±„Å®Tension„ÇíÂâäÈô§„Åó„ÄÅ„Ç∑„Çπ„ÉÜ„É†„ÇíÂàùÊúüÁä∂ÊÖã„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÄÇ„Çà„Çç„Åó„ÅÑ„Åß„Åô„ÅãÔºü")) {
        deleteAccounts();
        logToConsole("ÂÖ®„Å¶„ÅÆÂè£Â∫ßÊÉÖÂ†±„Å®Áä∂ÊÖã„ÅåÂâäÈô§„Åï„Çå„ÄÅ„Ç∑„Çπ„ÉÜ„É†„ÅØÂàùÊúüÁä∂ÊÖã„Å´„É™„Çª„ÉÉ„Éà„Åï„Çå„Åæ„Åó„Åü„ÄÇ", 'error-message');
        // Âº∑Âà∂„É™„É≠„Éº„Éâ
        window.location.reload(); 
    }
}


// =========================================================================
// UIÈÖçËâ≤„É™„Çª„ÉÉ„ÉàÊ©üËÉΩ
// =========================================================================

// Âæ©ÂÖÉ„Åó„Åü„ÅÑÂÆâÂÖ®„Å™CSS„ÅÆÂÖ®Êñá„ÇíÊñáÂ≠óÂàó„Å®„Åó„Å¶ÂÆöÁæ© (index.html„ÅÆ<style>„Çø„Ç∞„ÅÆÂÜÖÂÆπ„Å®ÂêåÊúü)
const CSS_DEFAULT_STATE = `
    /* üåü UIÂÖ®‰Ωì„ÅÆËâ≤„Å®Âü∫Êú¨„É¨„Ç§„Ç¢„Ç¶„Éà„ÅÆÊúÄÁµÇÂæ©ÂÖÉ üåü */
    body { 
        display: flex; 
        font-family: 'Segoe UI', 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; 
        margin: 0; 
        background-color: #f0f0f0; 
    }
    
    h2 { margin-top: 0; padding-top: 5px; border-bottom: 2px solid #ddd; padding-bottom: 5px; }
    h3 { margin-top: 0; margin-bottom: 10px; font-size: 1.1em; }

    #sidebar { 
        width: 350px; 
        background-color: #fff; 
        padding: 20px; 
        box-shadow: 2px 0 5px rgba(0, 0, 0, 0.1); 
    }
    #main-content { 
        flex-grow: 1; 
        padding: 20px; 
        display: flex; 
        flex-direction: column; 
        background-color: #f0f0f0; 
    }
    .gauge-area { 
        border: 1px solid #ddd; 
        padding: 15px; 
        margin-top: 15px; 
        border-radius: 5px; 
        background-color: #fff;
    }
    
    /* „Éï„Ç©„Éº„É†„Å®„É©„Éô„É´„ÅÆ„É¨„Ç§„Ç¢„Ç¶„Éà‰øÆÊ≠£ */
    .gauge-area label {
        display: block; 
        margin-top: 10px; 
        margin-bottom: 3px; 
        font-weight: bold;
    }
    .gauge-area input, .gauge-area select {
        width: 90%; 
        padding: 8px; 
        border: 1px solid #ccc; 
        border-radius: 3px; 
        box-sizing: border-box; 
        margin-top: 0;
        margin-bottom: 15px;
    }
    
    /* „Éú„Çø„É≥„ÅÆ„Çπ„Çø„Ç§„É´„Å®Ëâ≤ÂàÜ„Åë */
    .action-button { width: 100%; padding: 10px; margin-top: 5px; border: none; border-radius: 4px; color: white; cursor: pointer; }
    .action-internal { background-color: #007bff; }
    .action-external { background-color: #ffc107; }
    .action-revision { background-color: #28a745; }
    #delete_accounts_button { background-color: #A6A6A6; }
    
    #mint_execute_button { background-color: #FFA500; } 
    #exchange_button { background-color: #007bff; } 

    /* Tension Bar Style */
    #tension_bar { background-color: #e9ecef; border-radius: 5px; height: 10px; margin-top: 5px; overflow: hidden; }
    #tension_level_display_bar { height: 100%; width: 0%; transition: width 0.3s; background-color: #dc3545; }
    
    /* Dialogue Console Style */
    #dialogue-output { flex-grow: 1; border: 1px solid #ddd; background-color: #fff; padding: 10px; overflow-y: scroll; margin-bottom: 10px; border-radius: 5px; }
    .ai-message { color: #007bff; margin-bottom: 5px; }
    .error-message { color: #dc3545; font-weight: bold; }
    #input-area { display: flex; }
    #dialogue_input { flex-grow: 1; padding: 10px; margin-right: 10px; }
    #dialogue_button { padding: 10px 15px; background-color: #6c757d; color: white; border: none; border-radius: 4px; }
    
    #autonomy_status { color: #dc3545; } 
`;

/**
 * UIÈÖçËâ≤„ÇíÊó¢ÂÆö„ÅÆÂÆâÂÖ®„Å™Áä∂ÊÖã„Å´„É™„Çª„ÉÉ„Éà„Åô„Çã („Ç≠„É£„ÉÉ„Ç∑„É•Á†¥Â£äËæº„Åø)
 */
function resetCSS() {
    const styleElement = document.querySelector('style');
    const output = document.getElementById('dialogue-output');

    if (styleElement) {
        // 1. <style>„Çø„Ç∞„ÅÆÂÜÖÂÆπ„Çí„ÄÅÂÆâÂÖ®„Å™„Éá„Éï„Ç©„É´„ÉàCSS„Åß‰∏äÊõ∏„Åç
        styleElement.textContent = CSS_DEFAULT_STATE;
        
        output.innerHTML += `<div class="ai-message"><strong>[AUDIT]:</strong> UIÈÖçËâ≤„ÇíÊó¢ÂÆö„ÅÆÂÆâÂÖ®„Å™Áä∂ÊÖã„Å´„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åó„Åü„ÄÇ</div>`;

        // 2. üö® „Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÁÑ°Ë¶ñ„Åó„ÅüÂº∑Âà∂„É™„É≠„Éº„Éâ„ÇíÂÆüË°å
        alert('UIÈÖçËâ≤„Çí„É™„Çª„ÉÉ„Éà„Åó„Åæ„Åô„ÄÇOK„ÇíÊäº„Åô„Å®„ÄÅ„Ç≠„É£„ÉÉ„Ç∑„É•„ÇíÁÑ°Ë¶ñ„Åó„Å¶„Éö„Éº„Ç∏„ÇíÂº∑Âà∂ÂÜçË™≠„ÅøËæº„Åø„Åó„Åæ„Åô„ÄÇ');
        window.location.reload(true); 

    } else {
        output.innerHTML += `<div class="error-message"><strong>[AUDIT ERROR]:</strong> CSS„É™„Çª„ÉÉ„Éà„Å´Â§±Êïó„Åó„Åæ„Åó„Åü„ÄÇ<style>„Çø„Ç∞„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì„ÄÇ</div>`;
    }
}


// =========================================================================
// ÂàùÊúüÂåñ
// =========================================================================

/**
 * Mint „Å® Exchange „ÅÆÈÅ∏ÊäûËÇ¢„ÇíÂàùÊúüÂåñ„Åô„Çã
 */
function initializeCurrencySelectors() {
    const mintSelect = UI_ELEMENTS['mint_currency_select'];
    const fromSelect = UI_ELEMENTS['exchange_from_select'];
    const toSelect = UI_ELEMENTS['exchange_to_select'];

    if (!mintSelect || !fromSelect || !toSelect) return;

    SUPPORTED_CURRENCIES.forEach(currency => {
        const option = (c) => {
            const opt = document.createElement('option');
            opt.value = c;
            opt.textContent = c;
            return opt;
        };
        
        mintSelect.appendChild(option(currency).cloneNode(true));
        fromSelect.appendChild(option(currency).cloneNode(true));
        toSelect.appendChild(option(currency).cloneNode(true));
    });
    
    // „Éá„Éï„Ç©„É´„ÉàÂÄ§„ÅÆË®≠ÂÆö
    mintSelect.value = "JPY"; 
    fromSelect.value = "JPY"; 
    toSelect.value = "USD"; 
}


/**
 * „Ç¢„Éó„É™„Ç±„Éº„Ç∑„Éß„É≥„ÅÆÂàùÊúüÂåñ„ÇíË°å„ÅÜ„ÄÇ
 */
function initializeApp() {
    try {
        cacheUIElements();
        logToConsole("Logos Foundation„ÇíÂàùÊúüÂåñ‰∏≠...", 'system-message');
        
        const initialState = getCurrentState(); 
        logToConsole(`Áõ£Êüª„Ç≥„É≥„ÇΩ„Éº„É´Ëµ∑ÂãïÊàêÂäü„ÄÇ„Ç¢„ÇØ„ÉÜ„Ç£„Éñ„É¶„Éº„Ç∂„Éº: ${initialState.active_user}`, 'ai-message');

        initializeCurrencySelectors();

        // „Ç§„Éô„É≥„Éà„É™„Çπ„Éä„Éº„ÅÆËøΩÂä†
        if (UI_ELEMENTS['mint_execute_button']) {
            UI_ELEMENTS['mint_execute_button'].addEventListener('click', handleMintingExecuteAct);
        }
        if (UI_ELEMENTS['exchange_button']) {
            UI_ELEMENTS['exchange_button'].addEventListener('click', handleExchangeAct);
        }
        if (UI_ELEMENTS['transfer_internal_button']) { 
            UI_ELEMENTS['transfer_internal_button'].addEventListener('click', () => handleTransfer(false)); 
        }
        if (UI_ELEMENTS['transfer_external_button']) { 
            UI_ELEMENTS['transfer_external_button'].addEventListener('click', () => handleTransfer(true)); 
        }
        if (UI_ELEMENTS['active_user_select']) { 
            UI_ELEMENTS['active_user_select'].addEventListener('change', handleUserSelect); 
        }
        if (UI_ELEMENTS['delete_accounts_button']) { 
            UI_ELEMENTS['delete_accounts_button'].addEventListener('click', handleDeleteAccounts); 
        }
        // UIÈÖçËâ≤„É™„Çª„ÉÉ„Éà„Éú„Çø„É≥
        if (UI_ELEMENTS['css_reset_button']) {
             UI_ELEMENTS['css_reset_button'].addEventListener('click', resetCSS);
        }
        
        // Revision Petition („ÉÄ„Éü„Éº)
        if (UI_ELEMENTS['revision_button']) {
             UI_ELEMENTS['revision_button'].addEventListener('click', () => {
                 logToConsole("Ëá™ÂæãÁöÑ‰øÆÊ≠£Ë´ãÈ°ò„Çí„É≠„Ç∞„Å´Ë®òÈå≤„Åó„Åæ„Åó„Åü„ÄÇTensionÂà∂Âæ°„Ç¢„É´„Ç¥„É™„Ç∫„É†„ÅåÊ§úË®é„Åó„Åæ„Åô„ÄÇ", 'ai-message');
            });
        }
        
        updateUI(initialState);
        
    } catch (error) {
        console.error("Ëá¥ÂëΩÁöÑ„Å™ÂàùÊúüÂåñ„Ç®„É©„Éº:", error); 
        logToConsole(`Ëá¥ÂëΩÁöÑ„Å™ÂàùÊúüÂåñ„Ç®„É©„Éº: ${error.message}`, 'error-message');
        const statusEl = document.getElementById('status_message');
        if (statusEl) {
             statusEl.textContent = `[STATUS]: Ëá¥ÂëΩÁöÑ„Ç®„É©„ÉºÁô∫Áîü - „Ç≥„É≥„ÇΩ„Éº„É´„ÇíÁ¢∫Ë™ç`;
        }
    }
}

document.addEventListener('DOMContentLoaded', initializeApp);
